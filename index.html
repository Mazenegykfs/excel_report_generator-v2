<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Report Generator</title>
    <!-- Libraries for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Library for saving files (needed for TXT) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter for consistent styling */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header Styling */
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-radius: 20px 20px 0 0; /* Rounded top corners */
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Content Area */
        .content {
            padding: 40px;
        }

        /* Section Styling */
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: "📊";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff, #e8eeff);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: linear-gradient(135deg, #e8eeff, #d8deff);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff8f8, #ffe8e8);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #999;
        }

        /* File Info Display */
        .file-info {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-info-text {
            display: flex;
            align-items: center;
        }

        .file-info-text::before {
            content: "📄";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        /* Headers Grid */
        .headers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .header-item {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .header-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.4);
        }

        .header-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
        }

        .btn:disabled {
            background: #ddd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-report {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            box-shadow: 0 5px 15px rgba(253, 121, 168, 0.3);
        }

        .btn-report:hover {
            box-shadow: 0 8px 25px rgba(253, 121, 168, 0.4);
        }

        .controls {
            display: flex;
            flex-direction: column; /* Stack controls vertically */
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            align-items: center; /* Center items horizontally */
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #6c5ce7, #5f3dc4);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .filter-row {
            background: linear-gradient(135deg, #fdcb6e, #e17055) !important;
        }

        .filter-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 0.9rem;
        }

        .filter-select:focus {
            border-color: #667eea;
            outline: none;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table Container for Scroll */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        /* Success Message */
        .success-message {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
        }

        .success-message::before {
            content: "✅";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        /* Custom Message Box */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Default to none in CSS for robust hiding */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .message-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            font-family: 'Inter', sans-serif;
        }

        .message-box h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }

        .message-box p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.5;
        }

        .message-box button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-box button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }
        
        /* Styles for the hidden report content area, for HTML2Canvas */
        #reportPrintArea {
            /* These styles are crucial for html2canvas to render correctly */
            position: absolute;
            left: -9999px; /* Hide off-screen */
            top: -9999px; /* Hide off-screen */
            width: 794px; /* Approximate A4 width in pixels at 96 DPI (210mm * 3.7795 px/mm) */
            padding: 96px; /* Approximate 1-inch padding at 96 DPI */
            background-color: white;
            color: #333;
            font-family: 'Arial', 'Noto Sans Arabic', sans-serif; /* Prioritize Arial/Noto Sans Arabic for text */
            box-sizing: border-box; /* Include padding in width */
            direction: rtl; /* Set RTL direction for Arabic text */
            text-align: right; /* Align text to the right for RTL */
        }

        #reportPrintArea h1,
        #reportPrintArea h2,
        #reportPrintArea h3,
        #reportPrintArea p,
        #reportPrintArea ul,
        #reportPrintArea li {
            direction: rtl; /* Ensure RTL for all text within */
            text-align: right; /* Ensure right alignment for all text within */
        }
        #reportPrintArea h1 { font-size: 2.5em; color: #2E74B5; margin-bottom: 20px; }
        #reportPrintArea h2 { font-size: 2em; margin-bottom: 20px; }
        #reportPrintArea h3 { font-size: 1.5em; margin-top: 25px; margin-bottom: 10px; color: #333; }
        #reportPrintArea p { font-size: 1.2em; margin-bottom: 10px; }
        #reportPrintArea ul { list-style-type: disc; margin-right: 20px; padding-right: 0; margin-left: auto; text-align: right; } /* Adjust list for RTL */
        #reportPrintArea li { margin-bottom: 5px; }
        #reportPrintArea strong { color: #555; }
        #reportPrintArea .page-break-after { page-break-after: always; } /* For forcing page breaks in print */

        /* Styles for radio buttons */
        .report-type-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            font-size: 1.1rem;
            color: #333;
        }

        .report-type-selection label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 8px;
            background-color: #f0f4f8;
            transition: background-color 0.3s ease;
        }

        .report-type-selection label:hover {
            background-color: #e0e8f0;
        }

        .report-type-selection input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .report-type-selection input[type="radio"]:checked + span {
            font-weight: bold;
            color: #667eea;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Excel Report Generator</h1>
            <p>Developed by Dr. Mazen Badawy – Doctorate of TEFL</p>
        </div>

        <div class="content">
            <!-- File Upload Section -->
            <div class="section">
                <h2>Upload Excel File</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Click to upload or drag and drop your Excel file</div>
                    <div class="upload-subtext">Supports .xlsx and .xls files</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                </div>
                <div id="fileInfo" class="file-info hidden">
                    <div class="file-info-text">
                        <span id="fileName"></span>
                    </div>
                </div>
            </div>

            <!-- Headers Selection Section -->
            <div class="section hidden" id="headersSection">
                <h2>Select Column Headers</h2>
                <div id="headersGrid" class="headers-grid"></div>
                <div class="controls">
                    <button class="btn" id="selectBtn" disabled>Select Columns</button>
                </div>
            </div>

            <!-- Data Preview and Filtering Section -->
            <div class="section hidden" id="dataSection">
                <h2>Filter Data</h2>
                <div class="table-container">
                    <table class="data-table" id="dataTable"></table>
                </div>
                <div class="controls">
                    <!-- Report type selection radio buttons -->
                    <div class="report-type-selection">
                        <label>
                            <input type="radio" name="reportType" value="pdf" checked>
                            <span>PDF Report</span>
                        </label>
                        <label>
                            <input type="radio" name="reportType" value="txt">
                            <span>Text Report</span>
                        </label>
                    </div>
                    <button class="btn btn-report" id="reportBtn">Generate Report</button>
                </div>
                <div id="successMessage" class="success-message hidden">
                    Report generated successfully!
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box HTML -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxOkBtn">OK</button>
        </div>
    </div>

    <!-- Hidden div for report content to be rendered by html2canvas -->
    <div id="reportPrintArea"></div>

    <script>
        console.log('Script execution started.'); // Debugging log at the very beginning

        let workbook = null;
        let currentData = [];
        let selectedHeaders = [];
        let filteredData = []; // Data currently displayed in the table after filtering

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const headersSection = document.getElementById('headersSection');
        const dataSection = document.getElementById('dataSection');
        const headersGrid = document.getElementById('headersGrid');
        const selectBtn = document.getElementById('selectBtn');
        const reportBtn = document.getElementById('reportBtn');
        const dataTable = document.getElementById('dataTable');
        const successMessage = document.getElementById('successMessage');

        // Custom Message Box Elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxOkBtn = document.getElementById('messageBoxOkBtn');
        
        // Report Print Area Element
        const reportPrintArea = document.getElementById('reportPrintArea');

        // Report Type Radio Buttons
        const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');
        let selectedReportType = 'pdf'; // Default selected report type

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        selectBtn.addEventListener('click', showDataPreview);
        reportBtn.addEventListener('click', generateReport); // Calls the main generateReport function
        messageBoxOkBtn.addEventListener('click', hideMessageBox);

        // Listen for changes on report type radio buttons
        reportTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedReportType = e.target.value;
                console.log('Selected report type:', selectedReportType);
                updateReportButtonText(); // Update button text based on selection
            });
        });

        // Initialize button text on load
        document.addEventListener('DOMContentLoaded', updateReportButtonText);

        /**
         * Updates the text of the main report generation button.
         */
        function updateReportButtonText() {
            if (reportBtn) {
                if (selectedReportType === 'pdf') {
                    reportBtn.textContent = 'Generate PDF Report';
                } else if (selectedReportType === 'txt') {
                    reportBtn.textContent = 'Generate Text Report';
                }
            }
        }


        /**
         * Displays a custom message box instead of the browser's alert.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message to display.
         */
        function showMessageBox(title, message) {
            console.log('Showing message box:', title, message); // Debugging log
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.style.display = 'flex'; // Explicitly set display to flex
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            console.log('Hiding message box'); // Debugging log
            messageBoxOverlay.style.display = 'none'; // Explicitly set display to none
        }

        /**
         * Handles dragover event for file upload area.
         * @param {Event} e - The dragover event.
         */
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        /**
         * Handles dragleave event for file upload area.
         * @param {Event} e - The dragleave event.
         */
        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        /**
         * Handles drop event for file upload area.
         * @param {Event} e - The drop event.
         */
        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        /**
         * Handles file selection from input.
         * @param {Event} e - The change event from file input.
         */
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        /**
         * Processes the selected Excel file.
         * @param {File} file - The Excel file to process.
         */
        function processFile(file) {
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // CRITICAL CHANGE: Added cellDates: true to correctly parse dates
                    workbook = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    // Read data, ensuring to get headers from the first row
                    currentData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (currentData.length > 0) {
                        displayHeaders(currentData[0]); // Display headers from the first row
                        headersSection.classList.remove('hidden');
                        dataSection.classList.add('hidden'); // Hide data section until headers are selected
                    } else {
                        showMessageBox('File Error', 'The Excel file appears to be empty or does not contain data. Please upload a valid file.');
                        headersSection.classList.add('hidden');
                        dataSection.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error reading file:', error); // Debugging log
                    showMessageBox('File Read Error', 'There was an error reading your Excel file. Please ensure it is a valid .xlsx or .xls file and try again. Error details: ' + error.message);
                    headersSection.classList.add('hidden'); // Ensure sections are hidden on error
                    dataSection.classList.add('hidden');
                }
            };
            // Added an explicit check for the file object before reading
            if (file instanceof File) {
                reader.readAsBinaryString(file);
            } else {
                showMessageBox('File Error', 'No valid file was provided. Please select or drag an Excel file.');
                headersSection.classList.add('hidden');
                dataSection.classList.add('hidden');
            }
        }

        /**
         * Displays the column headers for selection.
         * @param {Array<string>} headers - An array of header names.
         */
        function displayHeaders(headers) {
            headersGrid.innerHTML = '';
            headers.forEach((header, index) => {
                // Only display non-empty headers
                if (header) {
                    const headerItem = document.createElement('div');
                    headerItem.className = 'header-item';
                    headerItem.innerHTML = `
                        <input type="checkbox" id="header-${index}" value="${index}">
                        <label for="header-${index}">${header}</label>
                    `;
                    headerItem.addEventListener('click', (e) => {
                        // Toggle checkbox state when header item is clicked, unless the click was directly on the checkbox
                        if (e.target.type !== 'checkbox') {
                            const checkbox = headerItem.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                        }
                        updateSelectButton();
                    });
                    headersGrid.appendChild(headerItem);
                }
            });
            updateSelectButton(); // Update button state initially
        }

        /**
         * Converts a value to a displayable string, handling Date objects.
         * @param {*} value - The value to convert.
         * @returns {string} The string representation.
         */
        function formatCellValue(value) {
            if (value instanceof Date) {
                // Format date as 'YYYY-MM-DD' or 'MM/DD/YYYY' based on preference
                // For consistency and general readability, let's use a standard format
                return value.toLocaleDateString('en-US'); // e.g., "7/8/2025"
            }
            return value || ''; // Return value as is, or empty string if null/undefined
        }

        /**
         * Updates the state of the "Select Columns" button based on checkbox selection.
         */
        function updateSelectButton() {
            const checkedBoxes = document.querySelectorAll('#headersGrid input[type="checkbox"]:checked');
            selectBtn.disabled = checkedBoxes.length === 0;
        }

        /**
         * Shows the data preview table with selected columns and initializes filters.
         */
        function showDataPreview() {
            const checkedBoxes = document.querySelectorAll('#headersGrid input[type="checkbox"]:checked');
            selectedHeaders = Array.from(checkedBoxes).map(cb => ({
                index: parseInt(cb.value),
                name: currentData[0][parseInt(cb.value)] // Get header name from the first row of currentData
            }));

            // Transform currentData (excluding header row) based on selected headers
            filteredData = currentData.slice(1).map(row => 
                selectedHeaders.reduce((obj, header) => {
                    // Use formatCellValue here to ensure dates are correctly displayed
                    obj[header.name] = formatCellValue(row[header.index]);
                    return obj;
                }, {})
            );

            createDataTable();
            dataSection.classList.remove('hidden');
            successMessage.classList.add('hidden'); // Hide any previous success messages
        }

        /**
         * Creates and populates the data table with filters.
         */
        function createDataTable() {
            let tableHTML = '<thead><tr>';
            
            // Add filter row at the top of the table header
            tableHTML += '<tr class="filter-row">';
            selectedHeaders.forEach(header => {
                // For filter dropdowns, we still want unique raw values before formatting for comparison
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[header.index]).filter(val => val !== undefined && val !== null && val !== '').map(val => formatCellValue(val)))].sort(); // Get unique formatted values for dropdown
                tableHTML += `<td>
                    <select class="filter-select" data-column="${header.name}">
                        <option value="">All ${header.name}</option>
                        ${uniqueValues.map(val => `<option value="${val}">${val}</option>`).join('')}
                    </select>
                </td>`;
            });
            tableHTML += '</tr>';

            // Add actual header row below the filter row
            selectedHeaders.forEach(header => {
                tableHTML += `<th>${header.name}</th>`;
            });
            tableHTML += '</tr></thead><tbody id="tableBody">';
            
            // Add data rows
            filteredData.forEach(row => {
                tableHTML += '<tr>';
                selectedHeaders.forEach(header => {
                    // Display formatted data
                    tableHTML += `<td>${row[header.name]}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            dataTable.innerHTML = tableHTML;

            // Add filter event listeners to the newly created selects
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', applyFilters);
            });
        }

        /**
         * Applies filters to the table rows based on selected dropdown values.
         */
        function applyFilters() {
            const filters = {};
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.value) {
                    filters[select.dataset.column] = select.value;
                }
            });

            const tbody = document.getElementById('tableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                let showRow = true;
                const cells = row.querySelectorAll('td');
                
                selectedHeaders.forEach((header, index) => {
                    // Filter based on the displayed (formatted) text content
                    if (filters[header.name] && cells[index].textContent.trim() !== String(filters[header.name]).trim()) {
                        showRow = false;
                    }
                });
                
                row.style.display = showRow ? '' : 'none'; // Show or hide the row
            });
        }

        /**
         * Main function to generate report based on selected type (PDF or TXT).
         */
        async function generateReport() {
            reportBtn.innerHTML = `<span class="loading"></span>Generating ${selectedReportType.toUpperCase()}...`;
            reportBtn.disabled = true;
            successMessage.classList.add('hidden'); // Hide previous success message

            try {
                // Get only visible rows from the table
                const visibleRowsData = [];
                const tableBody = document.getElementById('tableBody');
                if (tableBody) {
                    Array.from(tableBody.children).forEach(row => {
                        if (row.style.display !== 'none') { // Check if row is visible
                            const rowContent = {};
                            Array.from(row.querySelectorAll('td')).forEach((cell, index) => {
                                if (selectedHeaders[index]) {
                                    rowContent[selectedHeaders[index].name] = cell.textContent.trim();
                                }
                            });
                            visibleRowsData.push(rowContent);
                        }
                    });
                }
                
                if (visibleRowsData.length === 0) {
                    showMessageBox('No Data', 'No data visible in the table to generate a report. Apply filters or upload a file.');
                    reportBtn.innerHTML = `Generate ${selectedReportType.toUpperCase()} Report`;
                    reportBtn.disabled = false;
                    return;
                }

                if (selectedReportType === 'pdf') {
                    await generatePdf(visibleRowsData);
                } else if (selectedReportType === 'txt') {
                    await generateTxt(visibleRowsData);
                }

                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error('Error generating report:', error); // Detailed error logging
                showMessageBox('Report Generation Error', 'An error occurred while generating the report: ' + error.message + '. Please check the console for more details.');
            } finally {
                reportBtn.innerHTML = `Generate ${selectedReportType.toUpperCase()} Report`;
                reportBtn.disabled = false;
                reportPrintArea.innerHTML = ''; // Clear the hidden print area after generation
            }
        }


        /**
         * Generates the PDF report from the provided data using html2canvas.
         * @param {Array<Object>} data - The data to include in the report.
         */
        async function generatePdf(data) {
            // Ensure jsPDF and html2canvas are loaded
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                throw new Error('PDF generation libraries failed to load.');
            }

            // Initialize jsPDF document here
            const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');

            // --- Construct HTML content for the report print area ---
            reportPrintArea.innerHTML = ''; // Clear previous content

            let reportHtmlContent = `
                <h1 style="text-align: center; font-size: 2.5em; color: #2E74B5; margin-bottom: 20px;">Data Report</h1>
                <p style="text-align: center; font-size: 1.2em; font-style: italic; margin-bottom: 10px;">Developed by: Dr. Mazen Badawy – Doctorate of TEFL</p>
                <p style="text-align: center; font-size: 1.2em; margin-bottom: 30px;">Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p style="text-align: center; font-size: 1.5em; font-weight: bold; color: #2E74B5; margin-bottom: 40px;">Total Records: ${data.length}</p>
                <div class="page-break-after"></div> <!-- Page break after title page -->
                <h2 style="text-align: center; font-size: 2em; margin-bottom: 20px;">Filtered Data Details</h2>
            `;

            data.forEach((record, index) => {
                reportHtmlContent += `
                    <h3 style="font-size: 1.5em; margin-top: 25px; margin-bottom: 10px; color: #333;">Record ${index + 1}:</h3>
                    <ul style="list-style-type: disc; margin-right: 20px; padding-right: 0; margin-left: auto; text-align: right;">
                `;
                selectedHeaders.forEach(header => {
                    const fieldName = header.name;
                    const fieldValue = record[fieldName] || 'N/A';
                    reportHtmlContent += `<li style="margin-bottom: 5px;"><strong style="color: #555;">${fieldName}:</strong> ${fieldValue}</li>`;
                });
                reportHtmlContent += `</ul>`;
                
                if (index < data.length - 1 && (index + 1) % 5 === 0) { // Example: every 5 records, adjust as needed
                    reportHtmlContent += `<div class="page-break-after"></div>`;
                }
            });

            reportPrintArea.innerHTML = reportHtmlContent;

            // --- Generate PDF from the HTML content using html2canvas ---
            const canvas = await html2canvas(reportPrintArea, {
                scale: 2, // Increase scale for better resolution in PDF
                useCORS: true, // Enable CORS if you are loading external resources (e.g., fonts from CDN)
                logging: true, // Enable logging for debugging html2canvas issues
                windowWidth: reportPrintArea.scrollWidth, // Ensure all content is captured
                windowHeight: reportPrintArea.scrollHeight // Ensure all content is captured
            });

            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();

            const imgProps = canvas.width > 0 && canvas.height > 0 
                             ? doc.getImageProperties(imgData)
                             : { width: 0, height: 0 };

            const imgRatio = imgProps.height / imgProps.width;
            const imgDisplayWidth = pdfWidth;
            const imgDisplayHeight = imgDisplayWidth * imgRatio;

            let heightLeft = imgDisplayHeight;
            let position = 0;
            
            if (imgProps.width > 0 && imgProps.height > 0) {
                doc.addImage(imgData, 'PNG', 0, position, imgDisplayWidth, imgDisplayHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgDisplayHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgDisplayWidth, imgDisplayHeight);
                    heightLeft -= pdfHeight;
                }
            } else {
                throw new Error('Failed to capture report content for PDF. Canvas was empty or invalid.');
            }

            const pdfFileName = `Data_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(pdfFileName);
        }

        /**
         * Generates a plain text (.txt) report from the provided data.
         * @param {Array<Object>} data - The data to include in the report.
         */
        async function generateTxt(data) {
            // Ensure FileSaver.js is loaded
            if (typeof window.saveAs === 'undefined') {
                throw new Error('File saving library failed to load.');
            }

            let textContent = `--- Excel Data Report ---\n`;
            textContent += `Developed by: Dr. Mazen Badawy – Doctorate of TEFL\n`;
            textContent += `Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n`;
            textContent += `Total Records: ${data.length}\n\n`;
            textContent += `--- Filtered Data Details ---\n\n`;

            data.forEach((record, index) => {
                textContent += `Record ${index + 1}:\n`;
                selectedHeaders.forEach(header => {
                    const fieldName = header.name;
                    const fieldValue = record[fieldName] || 'N/A';
                    textContent += `  ${fieldName}: ${fieldValue}\n`;
                });
                textContent += `\n`; // Add a blank line between records
            });

            const txtFileName = `Data_Report_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            window.saveAs(blob, txtFileName);
        }

    </script>
</body>
</html>
